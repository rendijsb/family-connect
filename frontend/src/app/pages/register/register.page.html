<ion-content class="register-content">
  <div class="register-container">

    <!-- Header with Back Button -->
    <div class="header-section">
      <ion-button fill="clear" class="back-button" routerLink="/login">
        <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- Progress Indicator -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="(currentStep / totalSteps) * 100"></div>
        </div>
        <span class="progress-text">Step {{currentStep}} of {{totalSteps}}</span>
      </div>
    </div>

    <!-- Logo Section -->
    <div class="logo-section">
      <div class="logo-circle">
        <ion-icon name="person-outline" class="logo-icon"></ion-icon>
      </div>
      <h1 class="page-title">Create Account</h1>
      <p class="page-subtitle" *ngIf="currentStep === 1">Let's get you started with Family Connect</p>
      <p class="page-subtitle" *ngIf="currentStep === 2">Almost there! Set up your account security</p>
    </div>

    <!-- Registration Form -->
    <ion-card class="register-card">
      <ion-card-content class="card-content">
        <form [formGroup]="registerForm" (ngSubmit)="onRegister()">

          <!-- Step 1: Personal Information -->
          <div class="form-step" *ngIf="currentStep === 1">

            <!-- Name Fields -->
            <ion-grid class="name-grid">
              <ion-row>
                <ion-col size="6">
                  <div class="input-group">
                    <ion-item class="custom-item" lines="none">
                      <ion-icon name="person-outline" slot="start" class="input-icon"></ion-icon>
                      <ion-input
                        type="text"
                        placeholder="First Name"
                        formControlName="firstName"
                        class="custom-input"
                        [class.error]="registerForm.get('firstName')?.invalid && registerForm.get('firstName')?.touched">
                      </ion-input>
                    </ion-item>
                    <div class="error-text" *ngIf="registerForm.get('firstName')?.invalid && registerForm.get('firstName')?.touched">
                      <span *ngIf="registerForm.get('firstName')?.errors?.['required']">Required</span>
                      <span *ngIf="registerForm.get('firstName')?.errors?.['minlength']">Too short</span>
                    </div>
                  </div>
                </ion-col>
                <ion-col size="6">
                  <div class="input-group">
                    <ion-item class="custom-item" lines="none">
                      <ion-input
                        type="text"
                        placeholder="Last Name"
                        formControlName="lastName"
                        class="custom-input"
                        [class.error]="registerForm.get('lastName')?.invalid && registerForm.get('lastName')?.touched">
                      </ion-input>
                    </ion-item>
                    <div class="error-text" *ngIf="registerForm.get('lastName')?.invalid && registerForm.get('lastName')?.touched">
                      <span *ngIf="registerForm.get('lastName')?.errors?.['required']">Required</span>
                      <span *ngIf="registerForm.get('lastName')?.errors?.['minlength']">Too short</span>
                    </div>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>

            <!-- Email Input -->
            <div class="input-group">
              <ion-item class="custom-item" lines="none">
                <ion-icon name="mail-outline" slot="start" class="input-icon"></ion-icon>
                <ion-input
                  type="email"
                  placeholder="Email Address"
                  formControlName="email"
                  class="custom-input"
                  [class.error]="registerForm.get('email')?.invalid && registerForm.get('email')?.touched">
                </ion-input>
                <ion-icon
                  name="checkmark-outline"
                  slot="end"
                  class="validation-icon success"
                  *ngIf="registerForm.get('email')?.valid && registerForm.get('email')?.touched">
                </ion-icon>
              </ion-item>
              <div class="error-text" *ngIf="registerForm.get('email')?.invalid && registerForm.get('email')?.touched">
                <span *ngIf="registerForm.get('email')?.errors?.['required']">Email is required</span>
                <span *ngIf="registerForm.get('email')?.errors?.['email']">Please enter a valid email</span>
              </div>
            </div>

            <!-- Phone Input -->
            <div class="input-group">
              <ion-item class="custom-item" lines="none">
                <ion-icon name="phone-portrait-outline" slot="start" class="input-icon"></ion-icon>
                <ion-input
                  type="tel"
                  placeholder="Phone Number"
                  formControlName="phone"
                  class="custom-input"
                  [class.error]="registerForm.get('phone')?.invalid && registerForm.get('phone')?.touched">
                </ion-input>
                <ion-icon
                  name="checkmark-outline"
                  slot="end"
                  class="validation-icon success"
                  *ngIf="registerForm.get('phone')?.valid && registerForm.get('phone')?.touched">
                </ion-icon>
              </ion-item>
              <div class="error-text" *ngIf="registerForm.get('phone')?.invalid && registerForm.get('phone')?.touched">
                <span *ngIf="registerForm.get('phone')?.errors?.['pattern']">Please enter a valid phone number</span>
              </div>
            </div>

          </div>

          <!-- Step 2: Account Security -->
          <div class="form-step" *ngIf="currentStep === 2">

            <!-- Password Input -->
            <div class="input-group">
              <ion-item class="custom-item" lines="none">
                <ion-icon name="lock-closed-outline" slot="start" class="input-icon"></ion-icon>
                <ion-input
                  [type]="showPassword ? 'text' : 'password'"
                  placeholder="Create Password"
                  formControlName="password"
                  class="custom-input"
                  [class.error]="registerForm.get('password')?.invalid && registerForm.get('password')?.touched">
                </ion-input>
                <ion-icon
                  [name]="showPassword ? 'eye-off-outline' : 'eye-outline'"
                  slot="end"
                  class="password-toggle"
                  (click)="togglePasswordVisibility()">
                </ion-icon>
              </ion-item>

              <!-- Password Strength Indicator -->
              <div class="password-strength" *ngIf="registerForm.get('password')?.value">
                <div class="strength-bar">
                  <div
                    class="strength-fill"
                    [style.width]="getPasswordStrength().width"
                    [style.background-color]="getPasswordStrength().color">
                  </div>
                </div>
                <span class="strength-text" [style.color]="getPasswordStrength().color">
                  {{getPasswordStrength().strength}}
                </span>
              </div>

              <div class="error-text" *ngIf="registerForm.get('password')?.invalid && registerForm.get('password')?.touched">
                <span *ngIf="registerForm.get('password')?.errors?.['required']">Password is required</span>
                <span *ngIf="registerForm.get('password')?.errors?.['minlength']">Password must be at least 8 characters</span>
                <span *ngIf="registerForm.get('password')?.errors?.['weakPassword']">
                  Password must contain uppercase, lowercase, number and special character
                </span>
              </div>
            </div>

            <!-- Confirm Password Input -->
            <div class="input-group">
              <ion-item class="custom-item" lines="none">
                <ion-icon name="lock-closed-outline" slot="start" class="input-icon"></ion-icon>
                <ion-input
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  placeholder="Confirm Password"
                  formControlName="confirmPassword"
                  class="custom-input"
                  [class.error]="(registerForm.get('confirmPassword')?.invalid || registerForm.errors?.['passwordMismatch']) && registerForm.get('confirmPassword')?.touched">
                </ion-input>
                <ion-icon
                  [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'"
                  slot="end"
                  class="password-toggle"
                  (click)="toggleConfirmPasswordVisibility()">
                </ion-icon>
                <ion-icon
                  name="checkmark-outline"
                  slot="end"
                  class="validation-icon success"
                  *ngIf="!registerForm.errors?.['passwordMismatch'] && registerForm.get('confirmPassword')?.value && registerForm.get('password')?.value"
                  style="margin-right: 40px;">
                </ion-icon>
              </ion-item>
              <div class="error-text" *ngIf="((registerForm.get('confirmPassword')?.invalid || registerForm.errors?.['passwordMismatch']) && registerForm.get('confirmPassword')?.touched)">
                <span *ngIf="registerForm.get('confirmPassword')?.errors?.['required']">Please confirm your password</span>
                <span *ngIf="registerForm.errors?.['passwordMismatch']">Passwords do not match</span>
              </div>
            </div>

            <!-- Terms and Newsletter -->
            <div class="checkbox-group">
              <ion-item class="checkbox-item" lines="none">
                <ion-checkbox
                  formControlName="agreeToTerms"
                  class="custom-checkbox"
                  [class.error]="registerForm.get('agreeToTerms')?.invalid && registerForm.get('agreeToTerms')?.touched">
                </ion-checkbox>
                <ion-label class="checkbox-label">
                  I agree to the <a href="#" class="terms-link">Terms of Service</a> and <a href="#" class="terms-link">Privacy Policy</a>
                </ion-label>
              </ion-item>
              <div class="error-text" *ngIf="registerForm.get('agreeToTerms')?.invalid && registerForm.get('agreeToTerms')?.touched">
                You must agree to the terms to continue
              </div>

              <ion-item class="checkbox-item" lines="none">
                <ion-checkbox
                  formControlName="subscribeToNewsletter"
                  class="custom-checkbox">
                </ion-checkbox>
                <ion-label class="checkbox-label">
                  Subscribe to our newsletter for family tips and updates
                </ion-label>
              </ion-item>
            </div>

          </div>

          <!-- Navigation Buttons -->
          <div class="button-group">
            <ion-button
              *ngIf="currentStep > 1"
              fill="outline"
              expand="block"
              class="secondary-button"
              (click)="previousStep()">
              Previous
            </ion-button>

            <ion-button
              *ngIf="currentStep < totalSteps"
              expand="block"
              class="primary-button"
              (click)="nextStep()">
              Continue
            </ion-button>

            <ion-button
              *ngIf="currentStep === totalSteps"
              expand="block"
              type="submit"
              class="primary-button"
              [disabled]="!registerForm.valid || isLoading">
              <span *ngIf="!isLoading">Create Account</span>
              <ion-icon *ngIf="isLoading" name="reload-outline" class="spinning"></ion-icon>
            </ion-button>
          </div>

        </form>

        <!-- Social Registration (Step 1 only) -->
        <div class="social-section" *ngIf="currentStep === 1">
          <div class="divider">
            <span class="divider-text">or sign up with</span>
          </div>

          <div class="social-buttons">
            <ion-button fill="outline" class="social-button google" (click)="onSocialRegister('google')">
              <ion-icon name="logo-google" slot="start"></ion-icon>
              Google
            </ion-button>

            <ion-button fill="outline" class="social-button apple" (click)="onSocialRegister('apple')">
              <ion-icon name="logo-apple" slot="start"></ion-icon>
              Apple
            </ion-button>
          </div>
        </div>

        <!-- Sign In Link -->
        <div class="signin-section">
          <ion-text class="signin-text">
            Already have an account?
            <a routerLink="/login" class="signin-link">Sign in here</a>
          </ion-text>
        </div>

      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
